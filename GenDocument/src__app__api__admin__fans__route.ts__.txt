# route.ts
// src/app/api/admin/fans/route.ts

import { NextResponse } from 'next/server'
import { firestore } from '@/lib/firebase'
import {
  collection,
  getDocs,
  query,
  where,
  doc,
  updateDoc,
  addDoc,
  getDoc,
} from 'firebase/firestore'

import { requireAdmin } from '@/lib/auth'

// --------------------------------------------------------------
// GET â†’ Obtener lista de fans con estadÃ­sticas
// --------------------------------------------------------------
export async function GET() {
  try {
    const admin = await requireAdmin()
    if (!admin) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const usersRef = collection(firestore, 'users')
    const fansQuery = query(usersRef, where('role', '==', 'fan'))
    const snapshot = await getDocs(fansQuery)

    const favoritesRef = collection(firestore, 'favorites')
    const playlistsRef = collection(firestore, 'user_playlists')
    const activitiesRef = collection(firestore, 'activities')
    const rewardsRef = collection(firestore, 'rewards')

    const fans = await Promise.all(
      snapshot.docs.map(async (userDoc) => {
        const user = userDoc.data()
        const userId = userDoc.id

        const [favSnap, plSnap, actSnap, rewSnap] = await Promise.all([
          getDocs(query(favoritesRef, where('userId', '==', userId))),
          getDocs(query(playlistsRef, where('userId', '==', userId))),
          getDocs(query(activitiesRef, where('userId', '==', userId))),
          getDocs(query(rewardsRef, where('userId', '==', userId))),
        ])

        return {
          id: userId,
          ...user,
          _count: {
            favorites: favSnap.size,
            playlists: plSnap.size,
            activities: actSnap.size,
            rewards: rewSnap.size,
          },
        }
      })
    )

    return NextResponse.json(fans)
  } catch (error) {
    console.error('ðŸ”¥ Error fetching fans:', error)
    return NextResponse.json(
      { error: 'Error fetching fans' },
      { status: 500 }
    )
  }
}

// --------------------------------------------------------------
// POST â†’ Acciones administrativas sobre un fan
// --------------------------------------------------------------
export async function POST(request: Request) {
  try {
    const admin = await requireAdmin()
    if (!admin) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const { userId, action, type, title, description } = await request.json()

    if (!userId || !action) {
      return NextResponse.json(
        { error: 'User ID and action are required' },
        { status: 400 }
      )
    }

    const userRef = doc(firestore, 'users', userId)
    const userSnap = await getDoc(userRef)

    if (!userSnap.exists()) {
      return NextResponse.json({ error: 'User not found' }, { status: 404 })
    }

    const userData = userSnap.data()

    switch (action) {
      // ---------------------------
      case 'award_points': {
        const points = Number(type) || 100
        const currentPoints = userData.loyaltyPoints || 0

        await updateDoc(userRef, {
          loyaltyPoints: currentPoints + points,
        })

        await addDoc(collection(firestore, 'rewards'), {
          userId,
          type: 'points',
          title: title || `+${points} puntos`,
          description:
            description || 'Puntos otorgados por el administrador',
          unlockedAt: Date.now(),
        })
        break
      }

      // ---------------------------
      case 'award_badge': {
        await addDoc(collection(firestore, 'rewards'), {
          userId,
          type: 'badge',
          title: title || 'Insignia Especial',
          description:
            description || 'Insignia otorgada por el administrador',
          icon: type || 'ðŸ†',
          unlockedAt: Date.now(),
        })
        break
      }

      // ---------------------------
      case 'upgrade_tier': {
        const newTier = type || 'silver'

        await updateDoc(userRef, {
          tier: newTier,
        })

        await addDoc(collection(firestore, 'rewards'), {
          userId,
          type: 'tier_upgrade',
          title: `Actualizado a ${newTier}`,
          description:
            description || 'Nivel mejorado por el administrador',
          unlockedAt: Date.now(),
        })
        break
      }

      // ---------------------------
      case 'activate': {
        await updateDoc(userRef, { isActive: true })
        break
      }

      case 'deactivate': {
        await updateDoc(userRef, { isActive: false })
        break
      }

      // ---------------------------
      default:
        return NextResponse.json(
          { error: 'Invalid action' },
          { status: 400 }
        )
    }

    return NextResponse.json({ success: true })
  } catch (error) {
    console.error('ðŸ”¥ Error processing admin fan action:', error)
    return NextResponse.json(
      { error: 'Error processing action' },
      { status: 500 }
    )
  }
}

